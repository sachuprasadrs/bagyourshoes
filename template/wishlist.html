{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="utf-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <title>My Wishlist - BagYourShoe</title>
   <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
   <link rel="stylesheet" href="{% static 'css/style.css' %}">
   <link rel="stylesheet" href="{% static 'css/responsive.css' %}">
   <link rel="icon" href="{% static 'images/fevicon.png' %}" type="image/gif" />
   <link rel="stylesheet" href="{% static 'css/jquery.mCustomScrollbar.min.css' %}">
   <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
   <link rel="stylesheet" href="{% static 'css/owl.carousel.min.css' %}">
   <link rel="stylesheet" href="{% static 'css/owl.theme.default.min.css' %}">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css" media="screen">
   <style>
         body {
             margin: 0;
             padding: 0;
             background-color: #f8f9fa;
         }

         .wishlist-container {
             margin-top: 2rem;
             margin-bottom: 3rem;
         }

         .wishlist-item-card {
             background: white;
             border-radius: 8px;
             overflow: hidden;
             box-shadow: 0 2px 10px rgba(0,0,0,0.05);
             margin-bottom: 20px;
             transition: all 0.3s ease;
         }

         .wishlist-item-card:hover {
             box-shadow: 0 5px 20px rgba(0,0,0,0.1);
         }

         .wishlist-item-image {
             width: 120px;
             height: 120px;
             object-fit: cover;
             border-radius: 5px;
         }

         .wishlist-item-info {
             flex: 1;
             padding: 20px;
         }

         .wishlist-item-name {
             font-size: 18px;
             font-weight: bold;
             color: #212529;
             margin-bottom: 5px;
         }

         .wishlist-item-category {
             font-size: 14px;
             color: #6c757d;
             margin-bottom: 10px;
             text-transform: capitalize;
         }

         .wishlist-item-price {
             font-size: 20px;
             font-weight: bold;
             color: #f12a47;
             margin-bottom: 15px;
         }

         .wishlist-actions {
             display: flex;
             gap: 10px;
             align-items: center;
         }

         .btn-add-cart {
             background: #f12a47;
             color: white;
             padding: 10px 20px;
             border: none;
             border-radius: 4px;
             font-weight: bold;
             cursor: pointer;
             transition: all 0.3s ease;
         }

         .btn-add-cart:hover {
             background: #d81a37;
             color: white;
         }

         .btn-add-cart:disabled {
             background: #ccc;
             cursor: not-allowed;
         }

         .btn-remove {
             background: #e9ecef;
             color: #212529;
             padding: 10px 20px;
             border: none;
             border-radius: 4px;
             font-weight: bold;
             cursor: pointer;
             transition: all 0.3s ease;
         }

         .btn-remove:hover {
             background: #dc3545;
             color: white;
         }

         .size-selector {
             margin-bottom: 15px;
         }

         .size-selector label {
             display: block;
             font-size: 13px;
             font-weight: 600;
             margin-bottom: 5px;
             color: #495057;
         }

         .size-selector select {
             width: 100%;
             max-width: 200px;
             padding: 8px;
             border: 1px solid #ced4da;
             border-radius: 4px;
             font-size: 14px;
         }

         .qty-selector {
             margin-bottom: 15px;
         }

         .qty-selector label {
             display: block;
             font-size: 13px;
             font-weight: 600;
             margin-bottom: 5px;
             color: #495057;
         }

         .qty-selector input {
             width: 60px;
             padding: 8px;
             border: 1px solid #ced4da;
             border-radius: 4px;
             text-align: center;
             font-size: 14px;
         }

         .empty-wishlist {
             text-align: center;
             padding: 60px 20px;
             background: white;
             border-radius: 8px;
             box-shadow: 0 2px 10px rgba(0,0,0,0.05);
         }

         .empty-wishlist i {
             font-size: 80px;
             color: #dee2e6;
             margin-bottom: 20px;
         }

         .empty-wishlist h3 {
             color: #212529;
             margin-bottom: 15px;
         }

         .empty-wishlist p {
             color: #6c757d;
             margin-bottom: 25px;
         }

         /* Notification styles */
         .notification {
             position: fixed;
             top: 20px;
             right: 20px;
             padding: 15px 20px;
             border-radius: 5px;
             color: white;
             z-index: 9999;
             transform: translateY(-100px);
             opacity: 0;
             transition: all 0.5s ease;
             min-width: 250px;
             box-shadow: 0 5px 15px rgba(0,0,0,0.2);
         }

         .notification.show {
             transform: translateY(0);
             opacity: 1;
         }

         .notification.success {
             background: #28a745;
         }

         .notification.error {
             background: #dc3545;
         }
      </style>
   </head>

   <body class="main-layout">
      {% include 'header.html' %}

      <div class="container wishlist-container">
        <h2>My Wishlist</h2>
      {% if wishlist_items %}
      <div class="row">
      {% for item in wishlist_items %}
      <div class="col-lg-6">
      <div class="wishlist-item-card d-flex" id="wishlist-item-{{ item.id }}">
      <img src="{{ item.image_url }}" alt="{{ item.name }}" class="wishlist-item-image">
      <div class="wishlist-item-info">
      <h3 class="wishlist-item-name">{{ item.name }}</h3>
      <p class="wishlist-item-category">{{ item.category }}</p>
      <div class="wishlist-item-price">â‚¹{{ item.price|floatformat:2 }}</div>


      <form class="add-to-cart-form" data-product-type="{{ item.product_type }}" data-product-id="{{ item.product_id }}" data-item-id="{{ item.id }}">
      {% csrf_token %}
      <div class="size-selector">
      <label for="size-{{ item.id }}">Select Size:</label>
      <select name="size" id="size-{{ item.id }}" required>
      <option value="" disabled selected>Choose Size</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10">10</option>
      <option value="11">11</option>
      <option value="12">12</option>
      </select>
      </div>


      <div class="qty-selector">
      <label for="qty-{{ item.id }}">Quantity:</label>
      <input type="number" name="quantity" id="qty-{{ item.id }}" value="1" min="1" max="10">
      </div>


      <div class="wishlist-actions">
      <button type="submit" class="btn-add-cart"><i class="fa fa-shopping-cart"></i> Add to Cart</button>
      <button type="button" class="btn-remove remove-wishlist-btn" data-item-id="{{ item.id }}"> <i class="fa fa-trash"></i> Remove</button>
      </div>
      </form>
      </div>
      </div>
      </div>
      {% endfor %}
      </div>
      {% else %}
      <div class="empty-wishlist">
      <i class="fa fa-heart-o"></i>
      <h3>Your wishlist is empty</h3>
      <p>Save your favorite items to your wishlist!</p>
      <a href="/" class="btn btn-primary btn-lg"><i class="fa fa-shopping-bag"></i> Start Shopping</a>
      </div>
      {% endif %}
      </div>
      <div class="notification" id="notification"></div>

      {% include 'footer.html' %}

      <!-- Javascript files -->
      <script src="{% static 'js/jquery.min.js' %}"></script>
      <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
      <script src="{% static 'js/plugin.js' %}"></script>
      <script src="{% static 'js/jquery.mCustomScrollbar.concat.min.js' %}"></script>
      <script src="{% static 'js/custom.js' %}"></script>
      <script src="{% static 'js/owl.carousel.js' %}"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.js"></script>

      <script>
         $(document).ready(function(){

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            function showNotification(message, type) {
                var $notification = $('#notification');
                $notification.text(message);
                $notification.removeClass('success error').addClass(type);
                $notification.addClass('show');

                setTimeout(function() {
                   $notification.removeClass('show');
                }, 3000);
            }

            // Remove from wishlist
            $('.remove-wishlist-btn').on('click', function(e) {
               e.preventDefault();
               var $button = $(this);
               var itemId = $button.data('item-id');

               if (!confirm('Remove this item from your wishlist?')) {
                  return;
               }

               $button.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i>');

               $.ajax({
                   url: '/remove-from-wishlist/' + itemId + '/',
                  method: 'POST',
                  data: {
                     csrfmiddlewaretoken: getCookie('csrftoken')
                  },
                  success: function(response) {
                     if (response.success) {
                        $('#wishlist-item-' + itemId).fadeOut(300, function() {
                           $(this).remove();
                           if ($('.wishlist-item-card').length === 0) {
                              location.reload();
                           }
                        });
                        showNotification('Item removed from wishlist', 'success');
                     } else {
                        showNotification(response.error || 'Failed to remove item', 'error');
                        $button.prop('disabled', false).html('<i class="fa fa-trash"></i> Remove');
                     }
                  },
                  error: function(xhr) {
                     showNotification('Error removing item', 'error');
                     $button.prop('disabled', false).html('<i class="fa fa-trash"></i> Remove');
                  }
               });
            });

            // ADD TO CART FORM SUBMIT
            $('.add-to-cart-form').on('submit', function(e) {
                e.preventDefault();
                var $form = $(this);
                var $btn = $form.find('.btn-add-cart');
                var productType = $form.data('product-type');
                var productId = $form.data('product-id');
                var itemId = $form.data('item-id');
                var formData = new FormData(this);
                formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));

                $btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Adding...');

                $.ajax({
                    url: '/add-to-cart-from-wishlist/' + productType + '/' + productId + '/',
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(resp) {
                        if (resp.success) {
                            showNotification('Moved to Cart Successfully!', 'success');
                            $('#wishlist-item-' + itemId).fadeOut(300, function(){
                                $(this).remove();
                                if($('.wishlist-item-card').length === 0) location.reload();
                            });
                        } else {
                            showNotification(resp.error || 'Failed to add to cart', 'error');
                            $btn.prop('disabled', false).html('<i class="fa fa-shopping-cart"></i> Add to Cart');
                        }
                    },
                    error: function() {
                        showNotification('Error processing request', 'error');
                        $btn.prop('disabled', false).html('<i class="fa fa-shopping-cart"></i> Add to Cart');
                    }
                });
            });

         });
      </script>
   </body>
</html>