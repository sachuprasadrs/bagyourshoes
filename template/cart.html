{% load static %}
<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>My Cart & Wishlist - BagYourShoe</title>
      <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
      <link rel="stylesheet" href="{% static 'css/style.css' %}">
      <link rel="stylesheet" href="{% static 'css/responsive.css' %}">
      <link rel="icon" href="{% static 'images/fevicon.png' %}" type="image/gif" />
      <link rel="stylesheet" href="{% static 'css/jquery.mCustomScrollbar.min.css' %}">
      <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
      <link rel="stylesheet" href="{% static 'css/owl.carousel.min.css' %}">
      <link rel="stylesheet" href="{% static 'css/owl.theme.default.min.css' %}">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css" media="screen">
      <style>
         body { margin: 0; padding: 0; background-color: #f8f9fa; }
         .cart-container { margin-top: 2rem; margin-bottom: 3rem; }
         .cart-tabs .nav-link { color: #6c757d; font-weight: 600; padding: 12px 20px; }
         .cart-tabs .nav-link.active { color: #f12a47; background: white; border-bottom: 3px solid #f12a47; }
         .tab-content { background: white; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
         .cart-item-image { width: 80px; height: 80px; object-fit: cover; border-radius: 5px; }
         .cart-summary { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
         .cart-summary h4 { border-bottom: 2px solid #f12a47; padding-bottom: 10px; margin-bottom: 20px; }
         .payment-options-card { border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; margin-top: 20px; }
         .btn-checkout { width: 100%; padding: 12px; background: linear-gradient(135deg, #f12a47 0%, #d81a37 100%); color: white; border: none; border-radius: 5px; }
         .wishlist-item-card { border: 1px solid #e9ecef; padding: 15px; margin-bottom: 15px; }
         .wishlist-item-image { width: 100px; height: 100px; object-fit: cover; }
         .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 5px; color: white; z-index: 9999; transform: translateY(-100px); opacity: 0; transition: all 0.5s ease; }
         .notification.show { transform: translateY(0); opacity: 1; }
         .notification.success { background: #28a745; }
         .notification.error { background: #dc3545; }
      </style>
   </head>

   <body class="main-layout">
      {% include 'header.html' %}

      <div class="container cart-container">
         <h2 class="mb-4 text-center">My Cart & Wishlist</h2>

         {% if messages %}
            <div class="messages mb-4">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                {% endfor %}
            </div>
         {% endif %}

         <div class="cart-tabs">
            <ul class="nav nav-tabs" id="cartTabs" role="tablist">
               <li class="nav-item">
                  <a class="nav-link active" id="cart-tab" data-toggle="tab" href="#cart" role="tab">
                     <i class="fa fa-shopping-cart"></i> My Cart
                     {% if cart_items %}<span class="badge badge-danger">{{ cart_items|length }}</span>{% endif %}
                  </a>
               </li>
               <li class="nav-item">
                  <a class="nav-link" id="wishlist-tab" data-toggle="tab" href="#wishlist" role="tab">
                     <i class="fa fa-heart"></i> My Wishlist
                     {% if wishlist_items %}<span class="badge badge-danger">{{ wishlist_items|length }}</span>{% endif %}
                  </a>
               </li>
            </ul>
         </div>

         <div class="tab-content" id="cartTabContent">
            <!-- CART TAB -->
            <div class="tab-pane fade show active" id="cart" role="tabpanel">
               {% if cart_items %}
                  <div class="row">
                     <div class="col-lg-8">
                        <div class="table-responsive">
                           <table class="table cart-table">
                              <thead>
                                 <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>Size</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                    <th>Action</th>
                                 </tr>
                              </thead>
                              <tbody>
                                 {% for item in cart_items %}
                                 <tr id="cart-item-{{ item.id }}">
                                    <td>
                                       <div class="d-flex align-items-center">
                                          <img src="{{ item.image_url }}" alt="{{ item.name }}" class="cart-item-image mr-3">
                                          <span>{{ item.name }}</span>
                                       </div>
                                    </td>
                                    <td>₹{{ item.price|floatformat:2 }}</td>
                                    <td>{{ item.size }}</td>
                                    <td>
                                       <div class="form-inline">
                                          <input type="number" name="quantity" value="{{ item.quantity }}" min="1" max="10" class="form-control quantity-input" style="width:60px">
                                          <button type="button" class="btn btn-sm btn-info update-qty-btn" data-item-id="{{ item.id }}"><i class="fa fa-refresh"></i></button>
                                       </div>
                                    </td>
                                    <td class="item-subtotal">₹{{ item.subtotal|floatformat:2 }}</td>
                                    <td>
                                       <button type="button" class="btn btn-sm btn-warning move-to-wishlist-btn" data-item-id="{{ item.id }}" data-product-type="{{ item.product_type }}" data-product-id="{{ item.product_id }}">
                                          <i class="fa fa-heart"></i>
                                       </button>
                                       <button type="button" class="btn btn-sm btn-danger remove-item-btn" data-item-id="{{ item.id }}">
                                          <i class="fa fa-trash"></i>
                                       </button>
                                    </td>
                                 </tr>
                                 {% endfor %}
                              </tbody>
                           </table>
                        </div>
                     </div>

                     <div class="col-lg-4">
                        <div class="cart-summary">
                           <h4>Cart Summary</h4>
                           <ul class="list-group list-group-flush">
                              <li class="list-group-item d-flex justify-content-between">
                                 <span>Subtotal</span>
                                 <span id="cart-subtotal">₹{{ total_amount|floatformat:2 }}</span>
                              </li>
                              <li class="list-group-item d-flex justify-content-between">
                                 <strong>Total</strong>
                                 <strong id="cart-total">₹{{ total_amount|floatformat:2 }}</strong>
                              </li>
                           </ul>
                        </div>

                        <div class="payment-options-card">
                           <h5>Payment Method</h5>
                           <div class="form-check">
                              <input class="form-check-input" type="radio" name="payment_method" id="pay_cod" value="COD" checked>
                              <label class="form-check-label" for="pay_cod">Cash on Delivery</label>
                           </div>
                           <div class="form-check mb-3">
                              <input class="form-check-input" type="radio" name="payment_method" id="pay_online" value="Online">
                              <label class="form-check-label" for="pay_online">Online Payment (Razorpay)</label>
                           </div>
                           <button type="button" class="btn btn-checkout" onclick="proceedToCheckout()">Proceed to Checkout</button>
                        </div>
                     </div>
                  </div>
               {% else %}
                  <div class="text-center py-5">
                     <h3>Your cart is empty</h3>
                     <a href="/" class="btn btn-primary mt-3">Continue Shopping</a>
                  </div>
               {% endif %}
            </div>

            <!-- WISHLIST TAB -->
            <div class="tab-pane fade" id="wishlist" role="tabpanel">
               {% if wishlist_items %}
                  <div class="row">
                     {% for item in wishlist_items %}
                     <div class="col-lg-6">
                        <div class="wishlist-item-card d-flex" id="wishlist-item-{{ item.id }}">
                           <img src="{{ item.image_url }}" class="wishlist-item-image">
                           <div class="wishlist-item-info pl-3">
                              <h5>{{ item.name }}</h5>
                              <p class="text-muted">{{ item.category }}</p>
                              <div class="text-danger font-weight-bold mb-2">₹{{ item.price|floatformat:2 }}</div>

                              <form class="add-to-cart-form" data-product-type="{{ item.product_type }}" data-product-id="{{ item.product_id }}" data-item-id="{{ item.id }}">
                                 {% csrf_token %}
                                 <select name="size" class="form-control mb-2" required>
                                    <option value="" disabled selected>Size</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                 </select>
                                 <input type="hidden" name="quantity" value="1">
                                 <button type="submit" class="btn btn-sm btn-danger">Add to Cart</button>
                                 <button type="button" class="btn btn-sm btn-light remove-wishlist-btn" data-item-id="{{ item.id }}">Remove</button>
                              </form>
                           </div>
                        </div>
                     </div>
                     {% endfor %}
                  </div>
               {% else %}
                  <div class="text-center py-5">
                     <h3>Wishlist Empty</h3>
                     <a href="/" class="btn btn-primary mt-3">Browse Products</a>
                  </div>
               {% endif %}
            </div>
         </div>
      </div>

      <div class="notification" id="notification"></div>
      {% include 'footer.html' %}

      <script src="{% static 'js/jquery.min.js' %}"></script>
      <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
      <script src="{% static 'js/plugin.js' %}"></script>
      <script src="{% static 'js/custom.js' %}"></script>

      <script>
      $(document).ready(function(){
         function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
               const cookies = document.cookie.split(';');
               for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                     cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                     break;
                  }
               }
            }
            return cookieValue;
         }

         function showNotification(message, type) {
            var $n = $('#notification');
            $n.text(message).removeClass('success error').addClass(type).addClass('show');
            setTimeout(function() { $n.removeClass('show'); }, 3000);
         }

         // Update Qty
         $('.update-qty-btn').click(function(){
            var id = $(this).data('item-id');
            var qty = $(this).siblings('input').val();
            $.post('/update-cart-quantity/'+id+'/', {quantity: qty, csrfmiddlewaretoken: getCookie('csrftoken')}, function(res){
               if(res.success) location.reload();
               else showNotification(res.error, 'error');
            });
         });

         // Remove Cart
         $('.remove-item-btn').click(function(){
            if(!confirm('Remove item?')) return;
            var id = $(this).data('item-id');
            $.post('/remove-from-cart/'+id+'/', {csrfmiddlewaretoken: getCookie('csrftoken')}, function(res){
               if(res.success) location.reload();
            });
         });

         // Remove Wishlist
         $('.remove-wishlist-btn').click(function(){
            if(!confirm('Remove item?')) return;
            var id = $(this).data('item-id');
            $.post('/remove-from-wishlist/'+id+'/', {csrfmiddlewaretoken: getCookie('csrftoken')}, function(res){
               if(res.success) location.reload();
            });
         });

         // Add to cart form (Wishlist tab)
         $('.add-to-cart-form').submit(function(e){
            e.preventDefault();
            var $form = $(this);
            var ptype = $form.data('product-type');
            var pid = $form.data('product-id');
            var data = new FormData(this);
            data.append('csrfmiddlewaretoken', getCookie('csrftoken'));

            $.ajax({
               url: '/add-to-cart-from-wishlist/'+ptype+'/'+pid+'/',
               type: 'POST', data: data, processData: false, contentType: false,
               success: function(res){
                  if(res.success) location.reload();
                  else showNotification(res.error, 'error');
               }
            });
         });

         // Move to wishlist button (Cart tab)
         $('.move-to-wishlist-btn').click(function(){
             var cartId = $(this).data('item-id');
             var ptype = $(this).data('product-type');
             var pid = $(this).data('product-id');

             // 1. Add to wishlist
             $.post('/add-to-wishlist/'+ptype+'/'+pid+'/', {csrfmiddlewaretoken: getCookie('csrftoken')}, function(res){
                 if(res.success || res.action === 'exists') {
                     // 2. Remove from cart
                     $.post('/remove-from-cart/'+cartId+'/', {csrfmiddlewaretoken: getCookie('csrftoken')}, function(rem){
                         if(rem.success) location.reload();
                     });
                 }
             });
         });
      });

      function proceedToCheckout() {
         var method = $('input[name="payment_method"]:checked').val();
         var normalized = method.toLowerCase() === 'online' ? 'razorpay' : 'cod';
         window.location.href = "{% url 'checkout_page' %}?payment_method=" + normalized;
      }
      </script>
   </body>
</html>